var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __values=this&&this.__values||function(o){var m=typeof Symbol==="function"&&o[Symbol.iterator],i=0;if(m)return m.call(o);return{next:function(){if(o&&i>=o.length)o=void 0;return{value:o&&o[i++],done:!o}}}};var __read=this&&this.__read||function(o,n){var m=typeof Symbol==="function"&&o[Symbol.iterator];if(!m)return o;var i=m.call(o),r,ar=[],e;try{while((n===void 0||n-- >0)&&!(r=i.next()).done)ar.push(r.value)}catch(error){e={error:error}}finally{try{if(r&&!r.done&&(m=i["return"]))m.call(i)}finally{if(e)throw e.error}}return ar};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __generator=this&&this.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var syncData;(function(syncData){var Endian=function(){function Endian(){}Endian.LITTLE_ENDIAN="littleEndian";Endian.BIG_ENDIAN="bigEndian";return Endian}();syncData.Endian=Endian;var ByteArray=function(){function ByteArray(buffer,bufferExtSize){if(bufferExtSize===void 0){bufferExtSize=0}this.bufferExtSize=0;this.EOF_byte=-1;this.EOF_code_point=-1;if(bufferExtSize<0){bufferExtSize=0}this.bufferExtSize=bufferExtSize;var bytes,wpos=0;if(buffer){var uint8=void 0;if(buffer instanceof Uint8Array){uint8=buffer;wpos=buffer.length}else{wpos=buffer.byteLength;uint8=new Uint8Array(buffer)}if(bufferExtSize==0){bytes=new Uint8Array(wpos)}else{var multi=(wpos/bufferExtSize|0)+1;bytes=new Uint8Array(multi*bufferExtSize)}bytes.set(uint8)}else{bytes=new Uint8Array(bufferExtSize)}this.write_position=wpos;this._position=0;this._bytes=bytes;this.data=new DataView(bytes.buffer);this.endian=Endian.BIG_ENDIAN}Object.defineProperty(ByteArray.prototype,"endian",{get:function(){return this.$endian==0?Endian.LITTLE_ENDIAN:Endian.BIG_ENDIAN},set:function(value){this.$endian=value==Endian.LITTLE_ENDIAN?0:1},enumerable:true,configurable:true});ByteArray.prototype.setArrayBuffer=function(buffer){};Object.defineProperty(ByteArray.prototype,"readAvailable",{get:function(){return this.write_position-this._position},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"buffer",{get:function(){return this.data.buffer.slice(0,this.write_position)},set:function(value){var wpos=value.byteLength;var uint8=new Uint8Array(value);var bufferExtSize=this.bufferExtSize;var bytes;if(bufferExtSize==0){bytes=new Uint8Array(wpos)}else{var multi=(wpos/bufferExtSize|0)+1;bytes=new Uint8Array(multi*bufferExtSize)}bytes.set(uint8);this.write_position=wpos;this._bytes=bytes;this.data=new DataView(bytes.buffer)},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"rawBuffer",{get:function(){return this.data.buffer},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"bytes",{get:function(){return this._bytes},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"dataView",{get:function(){return this.data},set:function(value){this.buffer=value.buffer},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"position",{get:function(){return this._position},set:function(value){this._position=value;if(value>this.write_position){this.write_position=value}},enumerable:true,configurable:true});Object.defineProperty(ByteArray.prototype,"length",{get:function(){return this.write_position},set:function(value){this.write_position=value;if(this.data.byteLength>value){this._position=value}this._validateBuffer(value)},enumerable:true,configurable:true});ByteArray.prototype._validateBuffer=function(value){if(this.data.byteLength<value){var be=this.bufferExtSize;var tmp=void 0;if(be==0){tmp=new Uint8Array(value)}else{var nLen=((value/be>>0)+1)*be;tmp=new Uint8Array(nLen)}tmp.set(this._bytes);this._bytes=tmp;this.data=new DataView(tmp.buffer)}};Object.defineProperty(ByteArray.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:true,configurable:true});ByteArray.prototype.clear=function(){var buffer=new ArrayBuffer(this.bufferExtSize);this.data=new DataView(buffer);this._bytes=new Uint8Array(buffer);this._position=0;this.write_position=0};ByteArray.prototype.readBoolean=function(){if(this.validate(1))return!!this._bytes[this.position++]};ByteArray.prototype.readByte=function(){if(this.validate(1))return this.data.getInt8(this.position++)};ByteArray.prototype.readBytes=function(bytes,offset,length){if(offset===void 0){offset=0}if(length===void 0){length=0}if(!bytes){return}var pos=this._position;var available=this.write_position-pos;if(available<0){console.error("遇到文件尾");return}if(length==0){length=available}else if(length>available){console.error("遇到文件尾");return}var position=bytes._position;bytes._position=0;bytes.validateBuffer(offset+length);bytes._position=position;bytes._bytes.set(this._bytes.subarray(pos,pos+length),offset);this.position+=length};ByteArray.prototype.readDouble=function(){if(this.validate(8)){var value=this.data.getFloat64(this._position,this.$endian==0);this.position+=8;return value}};ByteArray.prototype.readFloat=function(){if(this.validate(4)){var value=this.data.getFloat32(this._position,this.$endian==0);this.position+=4;return value}};ByteArray.prototype.readInt=function(){if(this.validate(4)){var value=this.data.getInt32(this._position,this.$endian==0);this.position+=4;return value}};ByteArray.prototype.readShort=function(){if(this.validate(2)){var value=this.data.getInt16(this._position,this.$endian==0);this.position+=2;return value}};ByteArray.prototype.readUnsignedByte=function(){if(this.validate(1))return this._bytes[this.position++]};ByteArray.prototype.readUnsignedInt=function(){if(this.validate(4)){var value=this.data.getUint32(this._position,this.$endian==0);this.position+=4;return value}};ByteArray.prototype.readUnsignedShort=function(){if(this.validate(2)){var value=this.data.getUint16(this._position,this.$endian==0);this.position+=2;return value}};ByteArray.prototype.readUTF=function(){var length=this.readUnsignedShort();if(length>0){return this.readUTFBytes(length)}else{return""}};ByteArray.prototype.readUTFBytes=function(length){if(!this.validate(length)){return}var data=this.data;var bytes=new Uint8Array(data.buffer,data.byteOffset+this._position,length);this.position+=length;return this.decodeUTF8(bytes)};ByteArray.prototype.writeBoolean=function(value){this.validateBuffer(1);this._bytes[this.position++]=+value};ByteArray.prototype.writeByte=function(value){this.validateBuffer(1);this._bytes[this.position++]=value&255};ByteArray.prototype.writeBytes=function(bytes,offset,length){if(offset===void 0){offset=0}if(length===void 0){length=0}var writeLength;if(offset<0){return}if(length<0){return}else if(length==0){writeLength=bytes.length-offset}else{writeLength=Math.min(bytes.length-offset,length)}if(writeLength>0){this.validateBuffer(writeLength);this._bytes.set(bytes._bytes.subarray(offset,offset+writeLength),this._position);this.position=this._position+writeLength}};ByteArray.prototype.writeDouble=function(value){this.validateBuffer(8);this.data.setFloat64(this._position,value,this.$endian==0);this.position+=8};ByteArray.prototype.writeFloat=function(value){this.validateBuffer(4);this.data.setFloat32(this._position,value,this.$endian==0);this.position+=4};ByteArray.prototype.writeInt=function(value){this.validateBuffer(4);this.data.setInt32(this._position,value,this.$endian==0);this.position+=4};ByteArray.prototype.writeShort=function(value){this.validateBuffer(2);this.data.setInt16(this._position,value,this.$endian==0);this.position+=2};ByteArray.prototype.writeUnsignedInt=function(value){this.validateBuffer(4);this.data.setUint32(this._position,value,this.$endian==0);this.position+=4};ByteArray.prototype.writeUnsignedShort=function(value){this.validateBuffer(2);this.data.setUint16(this._position,value,this.$endian==0);this.position+=2};ByteArray.prototype.writeUTF=function(value){var utf8bytes=this.encodeUTF8(value);var length=utf8bytes.length;this.validateBuffer(2+length);this.data.setUint16(this._position,length,this.$endian==0);this.position+=2;this._writeUint8Array(utf8bytes,false)};ByteArray.prototype.writeShortUTF=function(value){var utf8bytes=this.encodeUTF8(value);var length=utf8bytes.length;this.validateBuffer(1+length);this.data.setUint8(this._position,length);this.position+=1;this._writeUint8Array(utf8bytes,false)};ByteArray.prototype.writeUTFBytes=function(value){this._writeUint8Array(this.encodeUTF8(value))};ByteArray.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable};ByteArray.prototype._writeUint8Array=function(bytes,validateBuffer){if(validateBuffer===void 0){validateBuffer=true}var pos=this._position;var npos=pos+bytes.length;if(validateBuffer){this.validateBuffer(npos)}this.bytes.set(bytes,pos);this.position=npos};ByteArray.prototype.validate=function(len){var bl=this._bytes.length;if(bl>0&&this._position+len<=bl){return true}else{console.error("遇到文件尾")}};ByteArray.prototype.validateBuffer=function(len){this.write_position=len>this.write_position?len:this.write_position;len+=this._position;this._validateBuffer(len)};ByteArray.prototype.encodeUTF8=function(str){var pos=0;var codePoints=this.stringToCodePoints(str);var outputBytes=[];while(codePoints.length>pos){var code_point=codePoints[pos++];if(this.inRange(code_point,55296,57343)){this.encoderError(code_point)}else if(this.inRange(code_point,0,127)){outputBytes.push(code_point)}else{var count=void 0,offset=void 0;if(this.inRange(code_point,128,2047)){count=1;offset=192}else if(this.inRange(code_point,2048,65535)){count=2;offset=224}else if(this.inRange(code_point,65536,1114111)){count=3;offset=240}outputBytes.push(this.div(code_point,Math.pow(64,count))+offset);while(count>0){var temp=this.div(code_point,Math.pow(64,count-1));outputBytes.push(128+temp%64);count-=1}}}return new Uint8Array(outputBytes)};ByteArray.prototype.decodeUTF8=function(data){var fatal=false;var pos=0;var result="";var code_point;var utf8_code_point=0;var utf8_bytes_needed=0;var utf8_bytes_seen=0;var utf8_lower_boundary=0;while(data.length>pos){var _byte=data[pos++];if(_byte==this.EOF_byte){if(utf8_bytes_needed!=0){code_point=this.decoderError(fatal)}else{code_point=this.EOF_code_point}}else{if(utf8_bytes_needed==0){if(this.inRange(_byte,0,127)){code_point=_byte}else{if(this.inRange(_byte,194,223)){utf8_bytes_needed=1;utf8_lower_boundary=128;utf8_code_point=_byte-192}else if(this.inRange(_byte,224,239)){utf8_bytes_needed=2;utf8_lower_boundary=2048;utf8_code_point=_byte-224}else if(this.inRange(_byte,240,244)){utf8_bytes_needed=3;utf8_lower_boundary=65536;utf8_code_point=_byte-240}else{this.decoderError(fatal)}utf8_code_point=utf8_code_point*Math.pow(64,utf8_bytes_needed);code_point=null}}else if(!this.inRange(_byte,128,191)){utf8_code_point=0;utf8_bytes_needed=0;utf8_bytes_seen=0;utf8_lower_boundary=0;pos--;code_point=this.decoderError(fatal,_byte)}else{utf8_bytes_seen+=1;utf8_code_point=utf8_code_point+(_byte-128)*Math.pow(64,utf8_bytes_needed-utf8_bytes_seen);if(utf8_bytes_seen!==utf8_bytes_needed){code_point=null}else{var cp=utf8_code_point;var lower_boundary=utf8_lower_boundary;utf8_code_point=0;utf8_bytes_needed=0;utf8_bytes_seen=0;utf8_lower_boundary=0;if(this.inRange(cp,lower_boundary,1114111)&&!this.inRange(cp,55296,57343)){code_point=cp}else{code_point=this.decoderError(fatal,_byte)}}}}if(code_point!==null&&code_point!==this.EOF_code_point){if(code_point<=65535){if(code_point>0)result+=String.fromCharCode(code_point)}else{code_point-=65536;result+=String.fromCharCode(55296+(code_point>>10&1023));result+=String.fromCharCode(56320+(code_point&1023))}}}return result};ByteArray.prototype.encoderError=function(code_point){console.error("EncodingError! The code point "+code_point+" could not be encoded.")};ByteArray.prototype.decoderError=function(fatal,opt_code_point){if(fatal){console.error("DecodingError")}return opt_code_point||65533};ByteArray.prototype.inRange=function(a,min,max){return min<=a&&a<=max};ByteArray.prototype.div=function(n,d){return Math.floor(n/d)};ByteArray.prototype.stringToCodePoints=function(string){var cps=[];var i=0,n=string.length;while(i<string.length){var c=string.charCodeAt(i);if(!this.inRange(c,55296,57343)){cps.push(c)}else if(this.inRange(c,56320,57343)){cps.push(65533)}else{if(i==n-1){cps.push(65533)}else{var d=string.charCodeAt(i+1);if(this.inRange(d,56320,57343)){var a=c&1023;var b=d&1023;i+=1;cps.push(65536+(a<<10)+b)}else{cps.push(65533)}}}i+=1}return cps};return ByteArray}();syncData.ByteArray=ByteArray})(syncData||(syncData={}));var syncData;(function(syncData){function getDifference(target,keys){var historyValue=target.history;var currentValue=target;for(var i=0;i<keys.length;++i){var key=keys[i];if(typeof historyValue.get==="function"){historyValue=historyValue.get(key)}else if(typeof historyValue.getTime==="function"){historyValue=historyValue[key].getTime()}else{historyValue=historyValue[key]}if(!historyValue){if(i!=keys.length-1&&orange.debug){console.warn("syncData.getDifference 数据非法",keys)}return currentValue}if(typeof currentValue.get==="function"){currentValue=currentValue.get(key)}else if(typeof currentValue.getTime==="function"){currentValue=currentValue[key].getTime()}else{currentValue=currentValue[key]}}return currentValue-historyValue}syncData.getDifference=getDifference;function getDifferenceMap(target,keys){if(typeof keys==="string"){keys=[keys]}var result=new Map;var _loop_1=function(i){var key=keys[i];var history_1=target.history.get(key);var current=target[key];current.forEach(function(value,key){var historyValue=history_1.get(key)||0;if(value-historyValue!==0){result.set(key,value-historyValue)}});history_1.forEach(function(value,key){if(!result.has(key)){result.set(key,-value)}})};for(var i=0;i<keys.length;++i){_loop_1(i)}return result}syncData.getDifferenceMap=getDifferenceMap;function find(keys,value){var val=orange.GetUtil.getFromGlobal(keys);var flag=false;if(val&&val instanceof DataBase){val.$search("",value,function(findKeys,result){flag=true;console.log("[find] 找到对象:",keys+"."+findKeys,result)});if(!flag)console.log("[find] 没有查找到对应结果")}else{console.log("[find] 类型错误，无法查找")}}syncData.find=find;var DataBase=function(_super){__extends(DataBase,_super);function DataBase(){var _this=_super.call(this)||this;_this.properties=Object.getPrototypeOf(_this).constructor.properties;_this.history=new Map;return _this}DataBase.prototype.dispose=function(){var _this=this;orange.stop(this);orange.removeAllListeners(this);var properties=this.properties;properties.forEach(function(t,key){var e_1,_a;if(t.type==1){if(_this[key]){_this[key].dispose()}}else if(t.type==2){if(t.classType&&_this[key]){try{for(var _b=__values(_this[key]),_c=_b.next();!_c.done;_c=_b.next()){var item=_c.value;if(item)item.dispose()}}catch(e_1_1){e_1={error:e_1_1}}finally{try{if(_c&&!_c.done&&(_a=_b.return))_a.call(_b)}finally{if(e_1)throw e_1.error}}}}else if(t.type==3){if(t.classType&&_this[key]){_this[key].forEach(function(item){if(item)item.dispose()})}}})};DataBase.prototype.find=function(value){var find=false;this.$search("",value,function(key){find=true;console.log("[find] 找到结果:",key)});if(!find){console.log("[find] 没有找到对应的结果")}};DataBase.prototype.$search=function(keys,findValue,find){var _this=this;keys+=keys==""?"":".";this.properties.forEach(function(value,key){var subKeys=keys+key;if(value.type==0){if(typeof findValue==="function"){if(findValue(_this[key],subKeys))find(subKeys,_this[key])}else{if(_this[key]==findValue)find(subKeys,_this[key])}}else if(value.type==1){_this[key]&&_this[key].$search&&_this[key].$search(subKeys,findValue,find)}else if(value.type==2){_this[key]&&_this[key].forEach(function(item,ind){var ssubKeys=subKeys+("["+ind+"]");if(value.classType){item&&item.$search(ssubKeys,findValue,find)}else{if(typeof findValue==="function"){if(findValue(item,ssubKeys))find(ssubKeys,item)}else{if(item==findValue)find(ssubKeys,item)}}})}else if(value.type==3){_this[key]&&_this[key].forEach(function(item,k){var ssubKeys=subKeys+(".get("+(typeof k==="string"?'"'+k+'"':k)+")");if(value.classType){if(item){if(item.$search){item.$search(ssubKeys,findValue,find)}else if(typeof item==="object"){for(var ok in item){var sssubKeys=ssubKeys+"."+ok;if(typeof findValue==="function"){if(findValue(item[ok],sssubKeys))find(sssubKeys,item)}else{if(item[ok]==findValue)find(sssubKeys,item[ok])}}}}}else{if(typeof findValue==="function"){if(findValue(item,ssubKeys))find(ssubKeys,item)}else{if(item==findValue)find(ssubKeys,item)}}})}})};DataBase.prototype.toJSON=function(){var _this=this;var obj={};this.properties.forEach(function(value,key){var e_2,_a,e_3,_b;if(value.type==0)obj[key]=_this[key];if(value.type==1)obj[key]=_this[key].toJSON();if(value.type==2){if(!value.classType){obj[key]=_this[key]}else{obj[key]=[];try{for(var _c=__values(_this[key]),_d=_c.next();!_d.done;_d=_c.next()){var item=_d.value;obj[key].push(item.toJSON())}}catch(e_2_1){e_2={error:e_2_1}}finally{try{if(_d&&!_d.done&&(_a=_c.return))_a.call(_c)}finally{if(e_2)throw e_2.error}}}}else if(value.type==3){if(!value.classType){obj[key]=_this[key]}else{obj[key]=new Map;try{for(var _e=__values(_this[key]),_f=_e.next();!_f.done;_f=_e.next()){var item=_f.value;obj[key].push(item.toJSON())}}catch(e_3_1){e_3={error:e_3_1}}finally{try{if(_f&&!_f.done&&(_b=_e.return))_b.call(_e)}finally{if(e_3)throw e_3.error}}}}else if(value.type===4){obj[key]=_this[key].toString()}});return obj};DataBase.prototype.createProperty=function(name){var t=this.properties.get(name);if(t.type==1)return new t.classType;if(t.type==2)return new Array;if(t.type==3)return new Map;if(t.type==4)return new Date;var type=typeof this[name];if(type==="string"){return""}else if(type==="boolean"){return false}else{return 0}};DataBase.prototype.reset=function(){var e_4,_a;var properties=this.properties;try{for(var properties_1=__values(properties),properties_1_1=properties_1.next();!properties_1_1.done;properties_1_1=properties_1.next()){var _b=__read(properties_1_1.value,2),k=_b[0],v=_b[1];if(v.type===0||v.type===4){this[k]=this.createProperty(k)}else if(v.type===1){if(this[k])this[k].reset()}else if(v.type===2){if(!this[k])this[k]=this.createProperty(k);if(this[k])this[k].length=0}else if(v.type===3){if(!this[k])this[k]=this.createProperty(k);if(this[k])this[k].clear()}}}catch(e_4_1){e_4={error:e_4_1}}finally{try{if(properties_1_1&&!properties_1_1.done&&(_a=properties_1.return))_a.call(properties_1)}finally{if(e_4)throw e_4.error}}};DataBase.prototype.clone=function(){var e_5,_a;var type=Object.getPrototypeOf(this);var obj=new type.constructor;var properties=this.properties;var _loop_2=function(k,v){if(v.type===0){obj[k]=this_1[k]}else if(v.type===1){if(this_1[k])obj[k]=this_1[k].clone();else obj[k]=this_1.createProperty(k)}else if(v.type===2){obj[k]=this_1.createProperty(k);if(this_1[k])this_1[k].forEach(function(item){return obj[k].push(item)})}else if(v.type===3){obj[k]=this_1.createProperty(k);if(this_1[k])this_1[k].forEach(function(item,itemKey){return obj[k].set(itemKey,item)})}else if(v.type===4){var date=this_1.createProperty(k);date.setTime(this_1[k].getTime());obj[k]=date}};var this_1=this;try{for(var properties_2=__values(properties),properties_2_1=properties_2.next();!properties_2_1.done;properties_2_1=properties_2.next()){var _b=__read(properties_2_1.value,2),k=_b[0],v=_b[1];_loop_2(k,v)}}catch(e_5_1){e_5={error:e_5_1}}finally{try{if(properties_2_1&&!properties_2_1.done&&(_a=properties_2.return))_a.call(properties_2)}finally{if(e_5)throw e_5.error}}return obj};DataBase.prototype.setValue=function(obj,path){var properties=this.properties;var _loop_3=function(key){var e_6,_a,e_7,_b;var value=obj[key];var propertyType=properties.get(key);if(!propertyType)return"continue";if(value===null&&propertyType.useDefaultValue){if(propertyType.type==2){this_2[key].length=0}else if(propertyType.type==3){this_2[key].clear()}else{this_2[key]=this_2.createProperty(key)}return"continue"}if(propertyType.type==0){var oldValue=this_2[key];this_2[key]=value;if(propertyType.recordFlag){this_2.setHistoryValue(key,oldValue,value)}}else if(propertyType.type==1){if(this_2[key]){var objKeyName=this_2[key]._key_;if(objKeyName&&value.hasOwnProperty(objKeyName)&&this_2[key][objKeyName]!=value[objKeyName]){var e=new syncData.UpdateEvent(syncData.UpdateEvent.RESET_DATA);e.data=this_2[key];e.name=key;e.path=path+"."+key;e.proxy=syncData.UpdateEvent.$proxy;syncData.UpdateEvent.emitter.emit(e);this_2[key].reset()}}else{this_2[key]=this_2.createProperty(key)}this_2[key].setValue(value,path+"."+key)}else if(propertyType.type==2){var oldValue=this_2[key];if(value==null){this_2[key]=[]}else{if(propertyType.classType){if(this_2[key]){try{for(var _c=__values(this_2[key]),_d=_c.next();!_d.done;_d=_c.next()){var item=_d.value;item&&item.dispose()}}catch(e_6_1){e_6={error:e_6_1}}finally{try{if(_d&&!_d.done&&(_a=_c.return))_a.call(_c)}finally{if(e_6)throw e_6.error}}}this_2[key]=[];try{for(var value_1=__values(value),value_1_1=value_1.next();!value_1_1.done;value_1_1=value_1.next()){var itemValue=value_1_1.value;var item=new propertyType.classType;if(item.setValue){item.setValue(itemValue,path+"."+key+"["+value.indexOf(itemValue)+"]")}else{for(var k in itemValue){item[k]=value[k]}}this_2[key].push(item)}}catch(e_7_1){e_7={error:e_7_1}}finally{try{if(value_1_1&&!value_1_1.done&&(_b=value_1.return))_b.call(value_1)}finally{if(e_7)throw e_7.error}}}else{this_2[key]=value}}if(propertyType.recordFlag){this_2.setHistoryValue(key,oldValue,this_2[key])}}else if(propertyType.type==3){var map=this_2[key];var oldValue_1;if(propertyType.recordFlag){oldValue_1=new Map;map.forEach(function(v,k){return oldValue_1.set(k,v)})}if(value==null){map.clear()}else{for(var k in value){if(+k+""===k)k=+k;var val=value[k];if(val==null){map.delete(k)}else if(!map.has(k)){if(!propertyType.classType){map.set(k,value[k])}else{var item=new propertyType.classType;item.setValue(value[k],path+"."+key+".get("+(typeof k=="string"?'"'+k+'"':k)+")");map.set(k,item)}}else{if(propertyType.classType){var item=map.get(k);item.setValue(value[k],path+"."+key+".get("+(typeof k=="string"?'"'+k+'"':k)+")")}else{map.set(k,value[k])}}}}if(propertyType.recordFlag){this_2.setHistoryValue(key,oldValue_1,this_2[key])}}else if(propertyType.type===4){var oldValue=this_2[key];if(value instanceof Array){this_2[key]=new Date(value[0]*1e3+value[1]/1e6)}else{this_2[key]=new Date(value)}if(propertyType.recordFlag){this_2.setHistoryValue(key,oldValue,this_2[key])}}};var this_2=this;for(var key in obj){_loop_3(key)}};DataBase.prototype.setHistoryValue=function(key,oldValue,newValue){if(this.history.has(key)){this.history.set(key,oldValue)}else{this.history.set(key,newValue)}};DataBase.prototype.setMap=function(key,value,classDefine){var map=this[key];if(!classDefine)classDefine=this.properties.get(key).classType;if(value==null){map.clear();return}for(var k in value){if(+k+""===k)k=+k;var val=value[k];if(val==null){map.delete(k)}else if(!map.has(k)){if(!classDefine){map.set(k,value[k])}else{var item=new classDefine;item.setValue(value[k]);map.set(k,item)}}else{if(classDefine){var item=map.get(k);item.setValue(value[k])}else{map.set(k,value[k])}}}};DataBase.setMap=function(map,value,classDefine){if(value==null){map.clear();return}for(var k in value){if(+k+""===k)k=+k;var val=value[k];if(val==null){map.delete(k)}else if(!map.has(k)){if(!classDefine){map.set(k,value[k])}else{var item=new classDefine;item.setValue(value[k]);map.set(k,item)}}else{if(classDefine){var item=map.get(k);item.setValue(value[k])}else{map.set(k,value[k])}}}};__decorate([orange.watch],DataBase.prototype,"history",void 0);return DataBase}(orange.HashObject);syncData.DataBase=DataBase})(syncData||(syncData={}));try{window["syncData"]=syncData;window["orange"]["sync"]=syncData}catch(e){}var syncData;(function(syncData){var getDataType=function(target,propertyName){if(!target.constructor.properties){target.constructor.properties=new Map}var properties=target.constructor.properties;var dataType=properties.get(propertyName);if(!dataType){dataType={type:0,classType:null,key:propertyName,recordFlag:false,useDefaultValue:false};properties.set(propertyName,dataType)}return dataType};syncData.type=function(type,classType){return function(target,propertyName){var dataType=getDataType(target,propertyName);dataType.type=type;dataType.classType=classType}};syncData.record=function(value){return function(target,propertyName){var dataType=getDataType(target,propertyName);dataType.recordFlag=value}};syncData.defaultValue=function(value){return function(target,propertyName){var dataType=getDataType(target,propertyName);dataType.useDefaultValue=value}}})(syncData||(syncData={}));var syncData;(function(syncData){var NetReceiveMessage=function(){function NetReceiveMessage(resp){Object.assign(this,resp)}NetReceiveMessage.prototype.getResponse=function(){var def=syncData.cmdMap[this.command];var cls=new window[def];cls.setValue(this.body);return cls};NetReceiveMessage.prototype.clone=function(){return new NetReceiveMessage(this)};return NetReceiveMessage}();syncData.NetReceiveMessage=NetReceiveMessage})(syncData||(syncData={}));var syncData;(function(syncData){var Protocol=function(){function Protocol(){this._seq=1;this.setSeq=0;this.compressed=null}Protocol.prototype.encode=function(data){var msgSeq=this.setSeq||this._seq++;var array=new syncData.ByteArray;array.writeShortUTF(data.srv);array.writeShortUTF(data.cmd);array.writeInt(msgSeq);if(this.compressed=="gzip"){array._writeUint8Array(msgpack.encode(data.params))}if(orange.hasListener(this,orange.Event.SEND)){orange.emitWith(this,orange.Event.SEND,data)}return{sequence:msgSeq,bytes:pako.gzip(array.bytes,{level:9})}};Protocol.prototype.decode=function(bytes){if(this.compressed=="gzip"){bytes=pako.ungzip(bytes)}var data=msgpack.decode(bytes);if(orange.hasListener(this,orange.Event.DATA)){orange.emitWith(this,orange.Event.DATA,data)}return new syncData.NetReceiveMessage({errorCode:data.code==null?0:data.code,errorMessage:data.error,command:data.cmd,sequence:data.rSeq,serverSequence:data.seq,serverTime:data.time,body:data.body?msgpack.decode(data.body):null})};return Protocol}();syncData.Protocol=Protocol})(syncData||(syncData={}));var syncData;(function(syncData){var Proxy=function(_super){__extends(Proxy,_super);function Proxy(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this._debug=false;_this.version="0.1.0";_this.root=null;_this.syncCommands=["Resp_Sync"];_this.syncAll=false;_this.lastSeq=0;_this.lastConnectTime=0;_this.reconnectCount=5;_this.curReconnectCount=0;_this.quit=false;_this.records={};return _this}Object.defineProperty(Proxy.prototype,"debug",{get:function(){return this._debug},set:function(val){orange.APIUtil.deprecatedTip("Proxy.debug",1543464755206,"不再需要单独设置网络打印，采用 orange.debug 进行判断");this._debug=val},enumerable:true,configurable:true});Object.defineProperty(Proxy.prototype,"cmdMap",{set:function(value){syncData.cmdMap=value},enumerable:true,configurable:true});Proxy.prototype.addSyncCommand=function(cmd){this.syncCommands.push(cmd)};Object.defineProperty(Proxy.prototype,"syncAllCommand",{set:function(val){this.syncAll=val},enumerable:true,configurable:true});Object.defineProperty(Proxy.prototype,"connection",{get:function(){return this._connection},set:function(c){var _this=this;this._connection=c;orange["$onAt"](this._connection,orange.Event.CLOSE,function(e){return __awaiter(_this,void 0,void 0,function(){var last,now,data,url,key;return __generator(this,function(_a){switch(_a.label){case 0:last=this.lastConnectTime;now=Date.now();this.lastConnectTime=now;if(!!this.quit)return[3,5];data=e.data;if(!(data.reason==orange.ConnectionCloseReason.DISCONNECT||data.reason==orange.ConnectionCloseReason.HERT_TIMEOUT||data.reason==orange.ConnectionCloseReason.RECONNECT_ERROR&&this.curReconnectCount<this.reconnectCount))return[3,4];e.stop();this.curReconnectCount++;orange.debug&&console.warn("第"+this.curReconnectCount+"重连");if(!(data.reason==orange.ConnectionCloseReason.RECONNECT_ERROR))return[3,2];return[4,orange.sleep(1e3)];case 1:_a.sent();_a.label=2;case 2:url=new orange.URLUtil(this._connection.url);url.params["seq"]=this.lastSeq;return[4,this._connection.reconnect(url.url)];case 3:_a.sent();this.curReconnectCount=0;for(key in this.records){this.connection.protocol.setSeq=+key;this.connection.send(this.records[key])}this.connection.protocol.setSeq=0;_a.label=4;case 4:return[3,6];case 5:clearInterval(this.clear);_a.label=6;case 6:return[2]}})})},null,0)},enumerable:true,configurable:true});Proxy.prototype.receive=function(data){if(data.serverSequence&&data.serverSequence<=this.lastSeq){console.warn("[过滤重复消息] id:"+data.command+", sequence:"+data.sequence+", serverSequence:"+data.serverSequence+", errorCode:"+data.errorCode+(data.errorCode!=0?", errorMessage:"+data.errorMessage+" ":"")+(data.sequence>0?"(客户端调用返回)":""));return}if(data.serverSequence&&data.serverSequence!=this.lastSeq+1){console.warn("[服务器消息丢失] id:"+data.command+", sequence:"+data.sequence+", serverSequence:"+data.serverSequence+", errorCode:"+data.errorCode+(data.errorCode!=0?", errorMessage:"+data.errorMessage+" ":"")+(data.sequence>0?"(客户端调用返回)":""));this.connection.close(orange.ConnectionCloseReason.SERVER_MESSAGE_LOST);return}if(data.errorCode<0){this.quit=true;console.warn("[错误码小于 0]",data);this.connection.close(orange.ConnectionCloseReason.ERROR_CODE,data)}orange.baseSync.serverTime=data.serverTime;data.serverSequence&&(this.lastSeq=data.serverSequence);delete this.records[data.sequence];if(orange.debug){console.log("[服务器消息] id:"+data.command+", cmd:"+syncData.cmdMap[data.command]+", sequence:"+data.sequence+", errorCode:"+data.errorCode+(data.errorCode!=0?", errorMessage:"+data.errorMessage+" ":"")+(data.sequence>0?"(客户端调用返回)":""));data.body&&console.log(data.body)}if(this.syncCommands){syncData.UpdateEvent.$proxy=this;if(this.syncAll||this.syncCommands.indexOf(data.command)!=-1){for(var k in data.body){if(this.root[k]){var objKeyName=this.root[k]._key_;if(objKeyName&&data.body[k].hasOwnProperty(objKeyName)&&data.body[k][objKeyName]!=this.root[k][objKeyName]){var e=new syncData.UpdateEvent(syncData.UpdateEvent.RESET_DATA);e.data=this.root[k];e.name=e.path=k;e.proxy=syncData.UpdateEvent.$proxy;syncData.UpdateEvent.emitter.emit(e);this.root[k].reset()}this.root[k].setValue(data.body[k])}}}syncData.UpdateEvent.$proxy=null}this.resolveAsyncMessage(data.sequence,data.clone());this.receiveMessage(data.command,data)};Proxy.prototype.send=function(data){var sendBack=_super.prototype.send.call(this,data);if(orange.debug){console.log("[发送] ",data.srv+data.cmd,data,"sequence:"+sendBack.sequence)}this.records[sendBack.sequence]=data;return sendBack};Proxy.prototype.request=function(data,back){var _this=this;return _super.prototype.request.call(this,data,back,function(sendBack){if(orange.debug){console.log("[发送] ",data.srv+data.cmd,data,"sequence:"+sendBack.sequence)}_this.records[sendBack.sequence]=data})};Proxy.self=true;__decorate([orange.modify],Proxy.prototype,"receive",null);return Proxy}(orange.NetProxy);syncData.Proxy=Proxy})(syncData||(syncData={}));var syncData;(function(syncData){var UpdateEvent=function(_super){__extends(UpdateEvent,_super);function UpdateEvent(){return _super!==null&&_super.apply(this,arguments)||this}Object.defineProperty(UpdateEvent,"emitter",{get:function(){if(!UpdateEvent.ist)UpdateEvent.ist=new orange.EventEmitter;return UpdateEvent.ist},enumerable:true,configurable:true});UpdateEvent.RESET_DATA="reset_data";return UpdateEvent}(orange.Event);syncData.UpdateEvent=UpdateEvent})(syncData||(syncData={}));var syncData;(function(syncData){function connect(url,params){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){return[2,new Promise(function(resolve,reject){var socket=new orange.WebSocketClient;socket.connect(url).then(function(connection){connection.protocol=new syncData.Protocol;var proxy=connection.proxy=new syncData.Proxy;if(params){params.connectTimeout!=null&&(connection.connectTimeout=params.connectTimeout);params.hertTimeout!=null&&(connection.hertTimeout=params.hertTimeout);params.hertTimeinterval!=null&&(connection.hertTimeinterval=params.hertTimeinterval);params.closeHandler!=null&&orange.on(connection,orange.Event.CLOSE,function(e){params.closeHandler(e.data)});params.compressed!=null&&(connection.protocol.compressed=params.compressed);params.debug!=null&&(proxy.debug=params.debug);params.commandTimeout!=null&&(proxy.commandTimeout=params.commandTimeout);params.reconnectInterval!=null&&(proxy.reconnectInterval=params.reconnectInterval);params.root!=null&&(proxy.root=params.root);params.syncAllCommand!=null&&(proxy.syncAllCommand=params.syncAllCommand)}resolve()}).catch(function(e){return reject(e)})})]})})}syncData.connect=connect})(syncData||(syncData={}));