var __values=this&&this.__values||function(o){var m=typeof Symbol==="function"&&o[Symbol.iterator],i=0;if(m)return m.call(o);return{next:function(){if(o&&i>=o.length)o=void 0;return{value:o&&o[i++],done:!o}}}};var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var ecs;(function(ecs){var Link=function(){function Link(){this.head=null;this.tail=null;this.length=0;this.nodes={}}Link.prototype.add=function(item){Link.addCount++;var key=item.id;if(this.nodes[key]!==undefined){return}var node=ecs.ObjectPools.linkPool.length?ecs.ObjectPools.linkPool.pop():new Node;node.key=key;node.value=item;if(this.head===null){this.head=node;this.tail=node}else{node.prev=this.tail;this.tail.next=node;this.tail=node}this.length++;this.nodes[key]=node};Link.prototype.remove=function(item){var key=item.id;Link.removeCount++;var node=this.nodes[key];if(node===undefined)return;if(node==this.head){this.head=node.next}else{node.prev.next=node.next}if(node==this.tail){this.tail=node.prev}else{node.next.prev=node.prev}this.length--;delete this.nodes[key];var value=node.value;node.value=null;ecs.ObjectPools.linkPrePool.push(node);return value};Object.defineProperty(Link.prototype,"toArray",{get:function(){var list=[];for(var node=this.head;node;node=node.next){list.push(node.value)}return list},enumerable:true,configurable:true});Link.prototype.has=function(item){return this.nodes[item.id]!==undefined};Link.prototype.get=function(item){if(this.nodes[item.id]===undefined)return;return this.nodes[item.id].value};Link.addCount=0;Link.removeCount=0;return Link}();ecs.Link=Link;var Node=function(){function Node(){this.prev=null;this.next=null}return Node}();ecs.Node=Node})(ecs||(ecs={}));var ecs;(function(ecs){var Broadcast=function(){function Broadcast(){this.bindings=[]}Broadcast.prototype.on=function(listener,listenerContext){var binding=new ListenerBinding(listener,listenerContext,false,this);this.bindings.push(binding);return binding};Broadcast.prototype.once=function(listener,listenerContext){var binding=new ListenerBinding(listener,listenerContext,true,this);this.bindings.push(binding);return binding};Broadcast.prototype.dispatch=function(){var params=[];for(var _i=0;_i<arguments.length;_i++){params[_i]=arguments[_i]}var e_1,_a;var flag=false;try{for(var _b=__values(this.bindings),_c=_b.next();!_c.done;_c=_b.next()){var item=_c.value;if(!item.hasDestroyed){item.execute.apply(item,params)}else{flag=true}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{if(_c&&!_c.done&&(_a=_b.return))_a.call(_b)}finally{if(e_1)throw e_1.error}}if(flag){for(var i=0;i<this.bindings.length;i++){if(this.bindings[i].hasDestroyed){this.bindings.splice(i,1);i--}}}};Broadcast.prototype.get=function(listener,listenerContext){var e_2,_a;try{for(var _b=__values(this.bindings),_c=_b.next();!_c.done;_c=_b.next()){var item=_c.value;if(item.listener==listener&&item.listenerContext==listenerContext&&!item.hasDestroyed)return item}}catch(e_2_1){e_2={error:e_2_1}}finally{try{if(_c&&!_c.done&&(_a=_b.return))_a.call(_b)}finally{if(e_2)throw e_2.error}}return null};Broadcast.prototype.has=function(listener,listenerContext){var e_3,_a;try{for(var _b=__values(this.bindings),_c=_b.next();!_c.done;_c=_b.next()){var item=_c.value;if(item.listener==listener&&item.listenerContext==listenerContext&&!item.hasDestroyed)return true}}catch(e_3_1){e_3={error:e_3_1}}finally{try{if(_c&&!_c.done&&(_a=_b.return))_a.call(_b)}finally{if(e_3)throw e_3.error}}return false};Broadcast.prototype.remove=function(listener,listenerContext){var e_4,_a;try{for(var _b=__values(this.bindings),_c=_b.next();!_c.done;_c=_b.next()){var item=_c.value;if(item.listener==listener&&item.listenerContext==listenerContext&&!item.hasDestroyed){return item.destroy()}}}catch(e_4_1){e_4={error:e_4_1}}finally{try{if(_c&&!_c.done&&(_a=_b.return))_a.call(_b)}finally{if(e_4)throw e_4.error}}};Broadcast.prototype.removeAll=function(){while(this.bindings.length){this.bindings.pop().destroy()}};return Broadcast}();ecs.Broadcast=Broadcast;var ListenerBinding=function(){function ListenerBinding(listener,listenerContext,once,boradcast){var _this=this;this.destroySelf=function(){_this.destroy()};this.listener=listener;this.listenerContext=listenerContext;this.once=once;this.broadcast=boradcast;this.hasDestroyed=false}ListenerBinding.prototype.execute=function(){var params=[];for(var _i=0;_i<arguments.length;_i++){params[_i]=arguments[_i]}if(!this.hasDestroyed){var result=this.listener.apply(this.listenerContext,params);if(this.once){this.destroy()}return result}return null};ListenerBinding.prototype.destroy=function(){this.listener=null;this.listenerContext=null;this.once=null;this.broadcast=null;this.hasDestroyed=true};return ListenerBinding}();ecs.ListenerBinding=ListenerBinding})(ecs||(ecs={}));var ecs;(function(ecs){ecs.$newComponent=false;var Component=function(){function Component(){ecs.$newComponent=true}Component.prototype.addComponent=function(componentClass){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}return this.entity?this.entity.addComponent.apply(this.entity,arguments):null};Component.prototype.removeComponent=function(componentClass){return this.entity?this.entity.removeComponent(componentClass):null};Component.prototype.removeComponents=function(componentClass){this.entity&&this.entity.removeComponents(componentClass)};Component.prototype.getComponent=function(componentClass){return this.entity?this.entity.getComponent(componentClass):null};Component.prototype.getComponents=function(componentClass){return this.entity?this.entity.getComponents(componentClass):null};Component.prototype.getComponentsInParent=function(componentClass){return this.entity?this.entity.getComponentsInParent(componentClass):null};Component.prototype.getComponentsInChildren=function(componentClass){return this.entity?this.entity.getComponentsInChildren(componentClass):null};Object.defineProperty(Component.prototype,"world",{get:function(){return this.entity&&this.entity.world},enumerable:true,configurable:true});Component.prototype.dispatch=function(type){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}this.entity.dispatch.apply(this.entity,arguments)};Component.prototype.getChildByName=function(name){if(!this.entity)return null;return this.entity.getChildByName(name)};Component.prototype.getChildByPath=function(name){if(!this.entity)return null;return this.entity.getChildByPath(name)};Component.prototype.destroy=function(){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.COMPONENT_HAS_DESTROYED,this);return}this.entity&&this.entity.removeComponent(this);this.entity=null;this.isAlive=false;Component.aliveCount--;ecs.debug&&ecs.ObjectPools.releaseId(this.id)};Component.register=function(componentClass){var e_5,_a,e_6,_b;if(componentClass.classType&&componentClass.classType.name===componentClass.name||componentClass==Component)return;ecs.ObjectPools.componentClasses.push(this);var type=new ComponentType;componentClass.classType=type;type.id=ecs.ObjectPools.getId(type);componentClass.id=type.id;type.name=componentClass.name;type.newCount=0;type.realNewCount=0;type.allowMultiply=componentClass.allowMultiply;type.requireComponents=[];try{for(var _c=__values(componentClass.requireComponents),_d=_c.next();!_d.done;_d=_c.next()){var requireComponentClass=_d.value;this.register(requireComponentClass);!~type.requireComponents.indexOf(requireComponentClass.classType)&&type.requireComponents.push(requireComponentClass.classType)}}catch(e_5_1){e_5={error:e_5_1}}finally{try{if(_d&&!_d.done&&(_a=_c.return))_a.call(_c)}finally{if(e_5)throw e_5.error}}this.componentClasses[type.id]=componentClass;type.types=[type];this.register(componentClass["__proto__"]);var parent=componentClass["__proto__"];while(parent!=Component){try{for(var _e=__values(parent.classType.requireComponents),_f=_e.next();!_f.done;_f=_e.next()){var requireComponentClass=_f.value;!~type.requireComponents.indexOf(requireComponentClass)&&type.requireComponents.push(requireComponentClass)}}catch(e_6_1){e_6={error:e_6_1}}finally{try{if(_f&&!_f.done&&(_b=_e.return))_b.call(_e)}finally{if(e_6)throw e_6.error}}type.types.push(parent.classType);parent=parent["__proto__"]}};Component.componentClasses=[];Component.aliveCount=0;Component.newCount=0;Component.realNewCount=0;Component.allowMultiply=true;Component.requireComponents=[];return Component}();ecs.Component=Component;var ComponentType=function(){function ComponentType(){}return ComponentType}();ecs.ComponentType=ComponentType})(ecs||(ecs={}));var ecs;(function(ecs){var Entity=function(_super){__extends(Entity,_super);function Entity(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.components=[];_this.componentTypes=[];_this.children=[];_this.isAlive=true;_this.property=null;_this.type=0;return _this}Entity.prototype.addComponent=function(componentClass){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}var classType;var component;var createComponent=false;if(!componentClass.classType||componentClass.id===componentClass.classType.id){ecs.Component.register(componentClass);classType=componentClass.classType;for(var i=0;i<classType.requireComponents.length;i++){if(!this.componentTypes[classType.requireComponents[i].id]||!this.componentTypes[classType.requireComponents[i].id].length){ecs.debug&&ecs.error(ecs.EMError.COMPONENT_REQUIRE,componentClass.classType.name,classType.requireComponents[i].name);return}}if(!classType.allowMultiply&&this.componentTypes[componentClass.classType.id]!==undefined){ecs.debug&&ecs.error(ecs.EMError.NOT_ALLOW_MUTIPLY_COMPONENT,componentClass.classType.name);return}ecs.$newComponent=false;component=ecs.$componentRecyclePool&&ecs.$componentRecyclePool.createComponent(componentClass)||new componentClass;if(ecs.$newComponent){componentClass.classType.realNewCount++;ecs.Component.realNewCount++}createComponent=true}else{classType=componentClass.classType;if(!classType.allowMultiply&&this.componentTypes[componentClass.classType.id]!==undefined){ecs.debug&&ecs.error(ecs.EMError.NOT_ALLOW_MUTIPLY_COMPONENT,componentClass.classType.name);return}component=componentClass}component.isAlive=true;componentClass.classType.newCount++;ecs.Component.newCount++;ecs.Component.aliveCount++;component.classType=componentClass.classType;this.components.push(component);for(var i=0;i<classType.types.length;i++){if(!this.componentTypes[classType.types[i].id])this.componentTypes[classType.types[i].id]=[];this.componentTypes[classType.types[i].id].push(component)}component.entity=this;component.id=ecs.ObjectPools.getId(component);createComponent&&component.init&&component.init.apply(component,args);this.world&&this.world.onAddComponent(this,component);return component};Entity.prototype.removeComponent=function(componentClass){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}var component;var componentIndex=-1;if(componentClass.id==componentClass.id){if(!this.componentTypes[componentClass.id].length)return;component=this.componentTypes[componentClass.id][0]}else{componentIndex=~this.components.indexOf(component);if(componentIndex)return}component.onDestroy&&component.onDestroy();this.world&&this.world.onRemoveComponent(this,component);component.entity=null;var index=this.componentTypes[componentClass.id].indexOf(component);if(index==this.componentTypes[componentClass.id].length-1)this.componentTypes[componentClass.id].pop();else this.componentTypes[componentClass.id].splice(index,1);if(componentIndex==this.components.length-1)this.components.pop();else this.components.splice(componentIndex,1);return component};Entity.prototype.removeComponents=function(componentClass){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}var components=this.componentTypes[componentClass.id];if(!components||!components.length)return;for(var i=0;i<components.length;i++){components[i].onDestroy&&components[i].onDestroy()}for(var i=components.length-1;i>=0;i--){this.world&&this.world.onRemoveComponent(this,components[i]);components[i].entity=null;var ind=this.components.indexOf(components[i]);if(ind==this.components.length-1)this.components.pop();else this.components.splice(ind,1);components.pop()}};Entity.prototype.getComponent=function(componentClass){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(!componentClass.classType)return;return this.componentTypes[componentClass.classType.id]&&this.componentTypes[componentClass.classType.id][0]};Entity.prototype.getComponents=function(componentClass){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(!componentClass.classType)return;return this.componentTypes[componentClass.classType.id]};Entity.prototype.getComponentsInParent=function(componentClass){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(!componentClass.classType)return;var list=[];var parent=this.parent;while(parent){var arr=parent.componentTypes[componentClass.classType.id];if(arr){for(var c=0;c<arr.length;c++){list.push(arr[c])}}}return list};Entity.prototype.getComponentsInChildren=function(componentClass){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(!componentClass.classType)return;return this.$getComponentsInChildren(componentClass,[])};Entity.prototype.$getComponentsInChildren=function(componentClass,list){for(var i=0;i<this.children.length;i++){var arr=this.children[i].componentTypes[componentClass.classType.id];if(arr){for(var c=0;c<arr.length;c++){list.push(arr[c])}}this.children[i].$getComponentsInChildren(componentClass,list)}return list};Entity.prototype.dispatch=function(type){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}for(var i=0;i<this.components.length;i++){this.components[i].receive&&this.components[i].receive.apply(this.components[i],arguments)}_super.prototype.dispatch.apply(this,arguments)};Entity.prototype.destroy=function(){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}for(var i=this.components.length-1;i>=0;i--){this.components[i].onDestroy&&this.components[i].onDestroy()}this._parent&&this.$setParent(null);while(this.children.length){this.children[this.children.length-1].destroy()}Entity.onDestroyEntity&&Entity.onDestroyEntity(this);this.property=null;for(var i=this.components.length-1;i>=0;i--){var component=this.components[i];component.entity=null;component.isAlive=false;ecs.Component.aliveCount--;ecs.$componentRecyclePool&&ecs.$componentRecyclePool.releaseComponent(component);ecs.debug&&ecs.ObjectPools.releaseId(component.id);this.components.pop()}ecs.debug&&ecs.ObjectPools.releaseId(this.id);this.componentTypes.length=0;this.removeAll();ecs.ObjectPools.entities.push(this);this.isAlive=false;Entity.aliveCount--};Object.defineProperty(Entity.prototype,"parent",{get:function(){return this._parent},set:function(val){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(this._parent==val)return;this.$setParent(val)},enumerable:true,configurable:true});Entity.prototype.addChild=function(entity){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(entity.parent==this){}else{entity.$setParent(this)}};Entity.prototype.addChildAt=function(entity,index){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED,this);return}if(entity.parent==this){var ind=this.children.indexOf(entity);if(ind!=index){this.children.splice(ind,1);this.children.splice(index,0,entity);Entity.onChangeEntityParent&&Entity.onChangeEntityParent(this,index)}}else{entity.$setParent(this,index)}};Entity.prototype.$setParent=function(val,index){if(index===void 0){index=-1}if(this._parent){this._parent.children.splice(this._parent.children.indexOf(this),1);this._parent=null;this.$setWorld(this._parent&&this._parent.world);Entity.onChangeEntityParent&&Entity.onChangeEntityParent(this)}this._parent=val;if(this._parent){var children=this._parent.children;if(~index){children.splice(index,0,this)}else{index=children.length;children.push(this)}this.$setWorld(this._parent&&this._parent.world);Entity.onChangeEntityParent&&Entity.onChangeEntityParent(this,index)}};Entity.prototype.getChildByName=function(name){for(var i=0;i<this.children.length;i++){if(this.children[i].name==name)return this.children[i]}return null};Entity.prototype.getChildByPath=function(name){var names=name.split(".");var entity=this;for(var n=0;n<names.length;n++){var find=null;for(var i=0;i<entity.children.length;i++){if(entity.children[i].name==names[n]){find=entity.children[i];break}}if(!find)return null;entity=find}return entity};Entity.prototype.$setWorld=function(val){if(!this.isAlive){ecs.debug&&ecs.error(ecs.EMError.ENEIEY_HAS_DESTROYED);return}if(val==this.world)return;!val&&this.world&&this.world.onRemoveEntity(this);this.world=val;this.world&&this.world.onAddEntity(this);for(var i=0,len=this.children.length;i<len;i++){this.children[i].$setWorld(this.world)}};Entity.create=function(type,name,tag){if(type===void 0){type=0}if(name===void 0){name=""}if(tag===void 0){tag=""}var entity;if(ecs.ObjectPools.entities.length){entity=ecs.ObjectPools.entities.pop();entity.isAlive=true}else{entity=new Entity;this.realNewCount++}entity.name=name;entity.tag=tag;entity.type=type;this.aliveCount++;this.newCount++;entity.id=ecs.ObjectPools.getId(entity);this.onCreateEntity&&this.onCreateEntity(entity);return entity};Entity.aliveCount=0;Entity.newCount=0;Entity.realNewCount=0;Entity.onCreateEntity=null;Entity.onDestroyEntity=null;Entity.onChangeEntityParent=null;return Entity}(ecs.Broadcast);ecs.Entity=Entity})(ecs||(ecs={}));var ecs;(function(ecs){ecs.$componentRecyclePool=null;function setComponentRecyclePool(pool){ecs.$componentRecyclePool=pool}ecs.setComponentRecyclePool=setComponentRecyclePool;var ObjectPools=function(){function ObjectPools(){}ObjectPools.prototype.releaseComponent=function(component){ObjectPools.components[component.classType.id].push(component)};ObjectPools.prototype.createComponent=function(componentClass){var pools=ObjectPools.components;var id=componentClass.classType.id;if(pools[id]===undefined)pools[id]=[];if(pools[id].length)return pools[id].pop();else return new componentClass};ObjectPools.getId=function(obj){if(ecs.debug){var key={id:this.id};this.allObjectsKeys[key.id]=key;this.allObjects.set(key,obj)}return this.id++};ObjectPools.releaseId=function(id){delete this.allObjectsKeys[id]};ObjectPools.clearLinkPrePool=function(){var prepool=this.linkPrePool;var pool=this.linkPool;for(var i=0,len=prepool.length;i<len;i++){var node=prepool.pop();if(!node)return;node.next=node.prev=null;pool.push(node)}};ObjectPools.components={};ObjectPools.componentClasses=[];ObjectPools.entities=[];ObjectPools.id=1;ObjectPools.allObjects=new WeakMap;ObjectPools.allObjectsKeys={};ObjectPools.linkPool=[];ObjectPools.linkPrePool=[];return ObjectPools}();ecs.ObjectPools=ObjectPools})(ecs||(ecs={}));var ecs;(function(ecs){var Query=function(_super){__extends(Query,_super);function Query(){return _super.call(this)||this}return Query}(ecs.Link);ecs.Query=Query;var EntityQuery=function(_super){__extends(EntityQuery,_super);function EntityQuery(componentClasses){var _this=_super.call(this)||this;_this.id=ecs.ObjectPools.getId(_this);_this.componentClassList=[];_this.componentClassMap={};_this.componentClassList=componentClasses;for(var i=0;i<_this.componentClassList.length;i++){_this.componentClassList[i].register(_this.componentClassList[i]);_this.componentClassMap[_this.componentClassList[i].classType.id]=_this.componentClassList[i]}return _this}EntityQuery.prototype.onAddEntity=function(entity){var list=this.componentClassList;for(var i=0;i<list.length;i++){if(!entity.componentTypes[list[i].classType.id]||!entity.componentTypes[list[i].classType.id].length){return}}this.add(entity)};EntityQuery.prototype.onRemoveEntity=function(entity){if(!this.has(entity))return;this.remove(entity)};EntityQuery.prototype.onAddComponent=function(entity,component){if(this.has(entity)||this.componentClassMap[component.classType.id]===undefined)return;var list=this.componentClassList;for(var i=0;i<list.length;i++){if(!entity.componentTypes[list[i].classType.id]||!entity.componentTypes[list[i].classType.id].length){return}}this.add(entity)};EntityQuery.prototype.onRemoveComponent=function(entity,component){if(!this.has(entity)||this.componentClassMap[component.classType.id]===undefined)return;this.remove(entity)};return EntityQuery}(Query);ecs.EntityQuery=EntityQuery;var ComponentQuery=function(_super){__extends(ComponentQuery,_super);function ComponentQuery(callName){var _this=_super.call(this)||this;_this.callName=callName;return _this}ComponentQuery.prototype.onAddEntity=function(entity){for(var i=0;i<entity.components.length;i++){var component=entity.components[i];if(component[this.callName]!==undefined&&typeof component[this.callName]==="function"){this.add(component)}}};ComponentQuery.prototype.onRemoveEntity=function(entity){for(var i=0;i<entity.components.length;i++){this.remove(entity.components[i])}};ComponentQuery.prototype.onAddComponent=function(entity,component){if(this.has(component))return;if(component[this.callName]!==undefined&&typeof component[this.callName]==="function"){this.add(component)}};ComponentQuery.prototype.onRemoveComponent=function(entity,component){if(!this.has(component))return;this.remove(component)};return ComponentQuery}(Query);ecs.ComponentQuery=ComponentQuery})(ecs||(ecs={}));var ecs;(function(ecs){var System=function(){function System(query){this.query=query}return System}();ecs.System=System})(ecs||(ecs={}));var ecs;(function(ecs){var UpdateInfo=function(){function UpdateInfo(){}return UpdateInfo}();ecs.UpdateInfo=UpdateInfo})(ecs||(ecs={}));var ecs;(function(ecs){var World=function(){function World(){this.entities=new ecs.Link;this.queries=[];this.systems=[];this.runInfo=new ecs.RunInfo;this.root=new RootEntity;this.root.world=this;this.onAddEntity(this.root);this._lastTime=Date.now();this.addSystem(new ecs.AwakeSystem);this.addSystem(new ecs.StartSystem);this.addSystem(new ecs.UpdateSystem);this.addSystem(new ecs.LateUpdateSystem)}World.prototype.update=function(dt){var e_7,_a,e_8,_b;var start=Date.now();dt=dt!=null?dt:start-this._lastTime;if(dt<0)dt=0;this._lastTime=start;try{for(var _c=__values(this.systems),_d=_c.next();!_d.done;_d=_c.next()){var sys=_d.value;sys.update&&sys.update(dt)}}catch(e_7_1){e_7={error:e_7_1}}finally{try{if(_d&&!_d.done&&(_a=_c.return))_a.call(_c)}finally{if(e_7)throw e_7.error}}var ut=Date.now()-start;try{for(var _e=__values(this.systems),_f=_e.next();!_f.done;_f=_e.next()){var sys=_f.value;sys.lateUpdate&&sys.lateUpdate(dt,ut)}}catch(e_8_1){e_8={error:e_8_1}}finally{try{if(_f&&!_f.done&&(_b=_e.return))_b.call(_e)}finally{if(e_8)throw e_8.error}}var at=Date.now()-start;if(at<5||ecs.ObjectPools.linkPrePool.length>1e4){ecs.ObjectPools.clearLinkPrePool()}this.runInfo.frame++;this.runInfo.lastProcessTime=at};World.prototype.onAddEntity=function(entity){this.entities.add(entity);if(entity.components.length){for(var i=0,len=this.queries.length;i<len;i++){this.queries[i].onAddEntity(entity)}}};World.prototype.onRemoveEntity=function(entity){this.entities.remove(entity);if(entity.components.length){for(var i=0,len=this.queries.length;i<len;i++){this.queries[i].onRemoveEntity(entity)}}};World.prototype.onAddComponent=function(entity,component){for(var i=0;i<this.queries.length;i++){this.queries[i].onAddComponent(entity,component)}};World.prototype.onRemoveComponent=function(entity,component){for(var i=0;i<this.queries.length;i++){this.queries[i].onRemoveComponent(entity,component)}};World.prototype.addSystem=function(system){if(this.systems.indexOf(system)!==-1)return;this.systems.push(system);if(system.query){this.queries.push(system.query);for(var entityNode=this.entities.head;entityNode;entityNode=entityNode.next){system.query.onAddEntity(entityNode.value)}}};World.prototype.removeSystem=function(system){if(this.systems.indexOf(system)===-1)return;this.systems.splice(this.systems.indexOf(system),1);system.query&&this.queries.splice(this.queries.indexOf(system.query),1)};Object.defineProperty(World.prototype,"scene",{get:function(){return this.$scene},set:function(val){this.$scene&&(this.$scene.parent=null);this.$scene=val;this.$scene&&(this.$scene.parent=this.root)},enumerable:true,configurable:true});return World}();ecs.World=World;var RootEntity=function(_super){__extends(RootEntity,_super);function RootEntity(){var _this=_super.call(this)||this;ecs.Entity.realNewCount++;ecs.Entity.newCount++;ecs.Entity.aliveCount++;ecs.Entity.onCreateEntity&&ecs.Entity.onCreateEntity(_this);return _this}RootEntity.prototype.$setParent=function(){return};RootEntity.prototype.$setWorld=function(){return};return RootEntity}(ecs.Entity)})(ecs||(ecs={}));var ecs;(function(ecs){ecs.debug=false;var EMError;(function(EMError){EMError[EMError["ENEIEY_HAS_DESTROYED"]=10002]="ENEIEY_HAS_DESTROYED";EMError[EMError["NOT_ALLOW_MUTIPLY_COMPONENT"]=11e3]="NOT_ALLOW_MUTIPLY_COMPONENT";EMError[EMError["COMPONENT_EXIST"]=11001]="COMPONENT_EXIST";EMError[EMError["COMPONENT_HAS_DESTROYED"]=11002]="COMPONENT_HAS_DESTROYED";EMError[EMError["COMPONENT_REQUIRE"]=11003]="COMPONENT_REQUIRE"})(EMError=ecs.EMError||(ecs.EMError={}));var ErrorMessage={10002:"Entity 已销毁",11e3:"Component 不容许有重复，类 : $arg0",11001:"Component 对象已存在",11002:"Component 已销毁",11003:"Component $arg0 缺少依赖，类 : $arg1"};var onError;function setOnError(call){onError=call}ecs.setOnError=setOnError;function error(type){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}if(onError){onError(type)}if(ecs.debug){var str=ErrorMessage[type];if(args&&args.length){for(var i=0;i<args.length;i++){str=str.replace("$arg"+i,args[i])}}logError(str)}}ecs.error=error;function logError(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}if(ecs.debug){console.error.apply(null,args)}}ecs.logError=logError;function logWarn(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}if(ecs.debug){console.error.apply(null,args)}}ecs.logWarn=logWarn;function logInfo(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}if(ecs.debug){console.error.apply(null,args)}}ecs.logInfo=logInfo})(ecs||(ecs={}));var ecs;(function(ecs){var RunInfo=function(){function RunInfo(){this.frame=0;this.lastProcessTime=0}return RunInfo}();ecs.RunInfo=RunInfo})(ecs||(ecs={}));var ecs;(function(ecs){var Scene=function(_super){__extends(Scene,_super);function Scene(){var _this=_super.call(this)||this;ecs.Entity.realNewCount++;ecs.Entity.newCount++;ecs.Entity.aliveCount++;ecs.Entity.onCreateEntity&&ecs.Entity.onCreateEntity(_this);return _this}Scene.prototype.$setParent=function(val){if(this.world&&this.world.$scene===this){this.world.$scene=null}_super.prototype.$setParent.call(this,val)};return Scene}(ecs.Entity);ecs.Scene=Scene})(ecs||(ecs={}));var ecs;(function(ecs){var ComponentSystem=function(_super){__extends(ComponentSystem,_super);function ComponentSystem(callName){return _super.call(this,new ecs.ComponentQuery(callName))||this}return ComponentSystem}(ecs.System);ecs.ComponentSystem=ComponentSystem})(ecs||(ecs={}));var ecs;(function(ecs){var EntitySystem=function(_super){__extends(EntitySystem,_super);function EntitySystem(componentClasses){return _super.call(this,new ecs.EntityQuery(componentClasses))||this}return EntitySystem}(ecs.System);ecs.EntitySystem=EntitySystem})(ecs||(ecs={}));var ecs;(function(ecs){var AwakeSystem=function(_super){__extends(AwakeSystem,_super);function AwakeSystem(){return _super.call(this,"awake")||this}AwakeSystem.prototype.update=function(dt){for(var node=this.query.head;node;node=node.next){node.value.awake();node.value&&this.query.remove(node.value)}};return AwakeSystem}(ecs.ComponentSystem);ecs.AwakeSystem=AwakeSystem})(ecs||(ecs={}));var ecs;(function(ecs){var LateUpdateSystem=function(_super){__extends(LateUpdateSystem,_super);function LateUpdateSystem(){return _super.call(this,"lateUpdate")||this}LateUpdateSystem.prototype.lateUpdate=function(dt,ut){for(var node=this.query.head;node;node=node.next){node.value.lateUpdate(dt,ut)}};return LateUpdateSystem}(ecs.ComponentSystem);ecs.LateUpdateSystem=LateUpdateSystem})(ecs||(ecs={}));var ecs;(function(ecs){var StartSystem=function(_super){__extends(StartSystem,_super);function StartSystem(){return _super.call(this,"start")||this}StartSystem.prototype.update=function(dt){for(var node=this.query.head;node;node=node.next){var value=node.value;this.query.remove(node.value);value.start()}};return StartSystem}(ecs.ComponentSystem);ecs.StartSystem=StartSystem})(ecs||(ecs={}));var ecs;(function(ecs){var UpdateSystem=function(_super){__extends(UpdateSystem,_super);function UpdateSystem(){return _super.call(this,"update")||this}UpdateSystem.prototype.update=function(dt){for(var node=this.query.head;node;node=node.next){node.value.update(dt)}};return UpdateSystem}(ecs.ComponentSystem);ecs.UpdateSystem=UpdateSystem})(ecs||(ecs={}));